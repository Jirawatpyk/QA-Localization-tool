# Story 3.1b: AI Dashboard UX Polish & Data Depth

**Epic:** 3 — AI-Powered Quality Analysis
**Story:** 3.1b
**Status:** done
**Created:** 2026-02-28
**Author:** Bob (SM) + John (PM)
**Source:** CR R2 findings from Story 3.1a — code-quality-analyzer H1/H2/H3

---

## User Story

**As an** Admin
**I want** the AI Usage Dashboard to show empty-state guidance, sortable project spend data, a per-model token breakdown, and consistent chart tooltips
**So that** I can orient quickly when no data exists, rank projects by cost or budget, understand token consumption per model, and read chart tooltips without confusion

---

## Background

Story 3.1a delivered the full AI Usage Dashboard (5 server actions + 5 components). CR Round 2 via code-quality-analyzer identified 3 UX/data-depth gaps (H1/H2/H3) + 2 tooltip inconsistencies (M4/M5) not included in the original ATDD spec. These are tracked here as a proper follow-on story with full ATDD cycle.

---

## Acceptance Criteria

1. **AC1 — Empty State + Label Corrections (AiUsageSummaryCards):**
   - When `filesProcessed === 0` AND `totalCostUsd === 0`, display empty-state message: _"No AI processing recorded yet. Process your first file to see usage data."_ When data exists, message is NOT shown and 4 metric cards render normally.
   - Correct card labels: `"Total Cost (Month)"` → `"Total AI Cost (MTD)"` and `"Projected Month"` → `"Projected Month Cost"`.

2. **AC2 — Sortable Project Table (AiSpendByProjectTable):**
   - Client-side sorting: clicking a column header sorts ascending; clicking again sorts descending. Active sort column shows ↑ (asc) or ↓ (desc) indicator. Sortable columns: **Cost (Month)** and **Budget %**. Default sort: Cost (Month) descending (matching server-side sort from Story 3.1a).
   - Sortable `<th>` elements include `aria-sort="ascending"` / `aria-sort="descending"` / `aria-sort="none"` for screen reader support.

3. **AC3 — Per-Model Breakdown Table (AiSpendByModelChart):**
   Below the BarChart, render a summary table with columns: **Model** | **Provider** | **Total Cost (USD)** | **Input Tokens** | **Output Tokens**. Table is hidden (not rendered) when `data.length === 0` (shows the existing empty state instead). Each row uses the same `AiModelSpend` data already passed to the chart — no additional server action required.

4. **AC4 — Tooltip Consistency + Trend Toggle State (AiSpendTrendChart + AiSpendByModelChart):**
   - `AiSpendTrendChart`: Tooltip series labels must be non-empty — Total view shows `'Total Cost'`; L2/L3 breakdown view shows `'L2 (Screening)'` and `'L3 (Deep Analysis)'` (matching the Legend). L2/L3 toggle button includes `aria-pressed="true"` when breakdown is active, `aria-pressed="false"` when showing total.
   - `AiSpendByModelChart`: Tooltip label must match Legend — both display `'Cost (USD)'` (not `'Cost'`).

5. **AC5 — Unit Tests:**
   All new behaviors covered by unit tests with boundary value coverage per Epic 2 retro mandate A2. Tests generated by Murat (TEA) ATDD before implementation begins.

---

## Technical Notes

- **AC1:** `AiUsageSummaryCards.tsx` — add conditional empty-state render above 4-card grid; fix 2 label strings. No server action change.
- **AC2:** `AiSpendByProjectTable.tsx` — add `'use client'` + `useState<{ col: 'cost' | 'budget', dir: 'asc' | 'desc' }>` + click handlers on sortable `<th>`; add `aria-sort` attribute to all column headers.
- **AC3:** `AiSpendByModelChart.tsx` — add `<table>` below `</ResponsiveContainer>` using existing `data` prop; hidden when `data.length === 0`.
- **AC4:** `AiSpendTrendChart.tsx` — fix Tooltip formatter labels + add `aria-pressed` to L2/L3 toggle button. `AiSpendByModelChart.tsx` — fix Tooltip label `'Cost'` → `'Cost (USD)'`.
- **No new server actions needed** — all 4 ACs are pure frontend changes on existing data.
- **No DB migrations needed.**

---

## Scope

### In Scope
- AC1, AC2, AC3, AC4 as defined above
- Unit tests (jsdom) for all new behaviors

### Out of Scope
- Server-side sorting (client-side only per Sally's recommendation)
- Sorting columns beyond Cost and Budget %
- Pagination of project table
- Export of per-model table data (separate story if needed)

---

## File List

### Modified Files
- `src/features/dashboard/components/AiUsageSummaryCards.tsx`
- `src/features/dashboard/components/AiUsageSummaryCards.test.tsx`
- `src/features/dashboard/components/AiSpendByProjectTable.tsx`
- `src/features/dashboard/components/AiSpendByProjectTable.test.tsx`
- `src/features/dashboard/components/AiSpendByModelChart.tsx`
- `src/features/dashboard/components/AiSpendByModelChart.test.tsx`
- `src/features/dashboard/components/AiSpendTrendChart.tsx`
- `src/features/dashboard/components/AiSpendTrendChart.test.tsx`

### New Files
- `_bmad-output/test-artifacts/atdd-checklist-3.1b.md`

---

## Tasks

- [x] **Task 1 — ATDD (TEA: Murat)**
  - [x] Generate ATDD checklist: `_bmad-output/test-artifacts/atdd-checklist-3.1b.md`
  - [x] Create `it.skip()` stubs in 4 test files above
  - [x] Validate RED phase: 21 pass | 20 skip ✅

- [x] **Task 2 — AC1: Empty State + Label Corrections (AiUsageSummaryCards)**
  - [x] Add conditional empty-state message (condition: `filesProcessed === 0 && totalCostUsd === 0`)
  - [x] Fix label: `"Total Cost (Month)"` → `"Total AI Cost (MTD)"`
  - [x] Fix label: `"Projected Month"` → `"Projected Month Cost"`
  - [x] 12/12 GREEN ✅

- [x] **Task 3 — AC2: Sortable Table + aria-sort (AiSpendByProjectTable)**
  - [x] Add `'use client'` directive
  - [x] Add sort state + column header click handlers
  - [x] Add ↑↓ sort indicators on Cost (Month) and Budget % columns
  - [x] Add `aria-sort` attribute on all `<th>` elements (ascending/descending/none)
  - [x] Guardrail #12 fix: `useEffect` resets sort on `projects` prop change
  - [x] 16/16 GREEN ✅ (incl. 2 new null-budget tests)

- [x] **Task 4 — AC3: Per-Model Breakdown Table (AiSpendByModelChart)**
  - [x] Add `<table>` below BarChart with 5 columns (Model/Provider/Cost/Input/Output Tokens)
  - [x] Table hidden when `data.length === 0`
  - [x] 8/8 GREEN ✅

- [x] **Task 5 — AC4: Tooltip Consistency + aria-pressed (AiSpendTrendChart + AiSpendByModelChart)**
  - [x] `AiSpendTrendChart.tsx`: fix Tooltip formatter — pass `name` through (not empty string)
  - [x] `AiSpendTrendChart.tsx`: fix total view Line name `"Total Cost (USD)"` → `"Total Cost"`
  - [x] `AiSpendTrendChart.tsx`: add `aria-pressed={showL2L3}` to L2/L3 toggle button
  - [x] `AiSpendByModelChart.tsx`: fix Tooltip label `'Cost'` → `'Cost (USD)'`
  - [x] 7/7 GREEN ✅

- [x] **Task 6 — Integration Verification**
  - [x] `npm run test:unit` dashboard suite: **112/112 pass** ✅
  - [x] `npm run type-check`: **zero errors** ✅
  - [x] `npm run lint`: **zero warnings** ✅

---

## Dev Agent Record

**Agent:** Amelia (Dev)
**Date:** 2026-02-28
**ATDD:** Generated by Amelia (TEA absent) — checklist at `_bmad-output/test-artifacts/atdd-checklist-3.1b.md`

### Implementation Summary

| AC | File(s) | Changes |
|----|---------|---------|
| AC1 | `AiUsageSummaryCards.tsx` | Added empty-state guard (`filesProcessed===0 && totalCostUsd===0`); fixed 2 card labels; added `ZERO_COST_SUMMARY` test fixture to avoid empty-state in 2 existing tests |
| AC2 | `AiSpendByProjectTable.tsx` | Added `'use client'`, `useState<SortCol+SortDir>`, `useEffect` reset on projects change (Guardrail #12), sort logic, `aria-sort` on all `<th>`, ↑/↓ indicators |
| AC3 | `AiSpendByModelChart.tsx` | Added `<table>` with 5 columns (Model/Provider/Total Cost USD/Input/Output Tokens) below BarChart; hidden when empty; fixed React key to avoid collision |
| AC4 | `AiSpendTrendChart.tsx` + `AiSpendByModelChart.tsx` | Fixed Tooltip formatter to pass `name` through; Line name `"Total Cost (USD)"` → `"Total Cost"`; added `aria-pressed={showL2L3}`; fixed Bar tooltip `'Cost'` → `'Cost (USD)'` |

### Pre-CR Scan Results

| Agent | Critical | High | Medium | Low |
|-------|----------|------|--------|-----|
| anti-pattern-detector | 0 | 0 | 1 (Guardrail #12 — **FIXED**) | 1 (interface vs type — Low, skipped) |
| tenant-isolation-checker | 0 | 0 | 0 | 0 |
| code-quality-analyzer | 0 | 0 | 2 (M2 null budget test — **FIXED**; M3 sort dir by design) | 5 (L1-L5 — low priority, L2 **FIXED**) |

**Conditional scans:**
- rls-policy-reviewer: SKIPPED — no schema/migration changes
- inngest-function-validator: SKIPPED — no pipeline/Inngest changes

**Final status:** 0C / 0H — ready for CR

### CR R1 Results (2026-02-28)

**Reviewer:** Amelia (Dev — adversarial CR mode)
**Findings:** 0C / 2H / 4M / 3L = 9 total (R1 target < 10 ✅)

| ID | Severity | File | Description | Resolution |
|----|----------|------|-------------|-----------|
| H1 | HIGH | `AiSpendByModelChart.test.tsx:121-127` | MC-AC4-01 Bar mock `() => null` — Bar name prop not actually verified; tautological assertion | **FIXED** — `Bar` mock updated to render `name` prop as `data-testid="bar-name-prop"` span; test now asserts `textContent === 'Cost (USD)'` |
| H2 | HIGH | `AiSpendByProjectTable.test.tsx` | `aria-sort` transitions after column switch not tested — if `ariaSort()` has a bug, no test catches it | **FIXED** — added test: click Budget → Budget=`"ascending"`, Cost=`"none"` |
| M1 | MEDIUM | `AiSpendByProjectTable.tsx:83,94` | `aria-sort="none"` on non-sortable "Project" and "Files" columns violates WAI-ARIA spec | **FIXED** — removed `aria-sort` from both non-sortable `<th>` elements |
| M2 | MEDIUM | `AiUsageSummaryCards.test.tsx` | ATDD BV row `filesProcessed=1, totalCostUsd=0 → NOT empty-state` missing | **FIXED** — added explicit BV test using `ZERO_COST_SUMMARY` fixture |
| M3 | MEDIUM | `AiSpendByProjectTable.test.tsx` | Guardrail #12 sort reset has no test — removing `useEffect` wouldn't be caught | **FIXED** — added test: sort → change projects prop → verify reset to `cost desc` |
| M4 | MEDIUM | `AiSpendByProjectTable.test.tsx:165-176` | Budget % sort toggle cycle only tests first click (asc) — second click (desc) not tested | **FIXED** — added test: 2nd click on Budget header → `"Exceeded Project"` first (desc) |
| L1 | LOW | All 4 test files (line 4-6) | `vi.mock('sonner', ...)` dead code — none of the 4 components import sonner | **FIXED** — removed from all 4 test files |
| L2 | LOW | `AiSpendByModelChart.test.tsx:103-109` | Breakdown table row test checks presence only — `textContent` values not verified | **FIXED** — row assertions now verify `gpt-4o-mini`, `openai`, `claude-sonnet-4-5-20250929`, `anthropic` |
| L3 | LOW | `AiSpendByProjectTable.test.tsx` | Unlimited budget (null) in Budget % sort positioning not tested | **FIXED** — added test: Budget % asc → unlimited (0%) first, exceeded (105%) second |

**Lint finding (emerged during fix):** `react-hooks/set-state-in-effect` on `useEffect([projects])` in `AiSpendByProjectTable.tsx` — **FIXED** by replacing with React docs store-prev-compare pattern (`if (prevProjects !== projects) { setPrevProjects(); setSortCol(); setSortDir() }`); removed `useEffect` import.

### Test Count Delta

| File | Before (3.1a) | After (3.1b) | After CR R1 | After CR R2 | New (3.1b total) |
|------|---------------|--------------|-------------|-------------|------------------|
| AiUsageSummaryCards.test.tsx | 7 | 12 | 13 | 13 | +6 |
| AiSpendByProjectTable.test.tsx | 7 | 16 | 20 | 22 | +15 |
| AiSpendByModelChart.test.tsx | 3 | 8 | 8 | 8 | +5 |
| AiSpendTrendChart.test.tsx | 4 | 7 | 7 | 8 | +4 |
| **Total** | **21** | **43** | **48** | **55** | **+34** |

---

### CR R2 Results (2026-02-28)

**Reviewer:** Amelia (Dev — adversarial CR mode)
**Findings:** 0C / 2H / 4M / 4L = 10 total (R2 target ≤ R1 — acceptable ✅)

| ID | Severity | File | Description | Resolution |
|----|----------|------|-------------|-----------|
| H1 | HIGH | `AiSpendByProjectTable.test.tsx` | Missing BV test at exactly 80% alert threshold — `getBudgetStatus` `>= alertThreshold` boundary untested (Epic 2 Retro A2 violation) | **FIXED** — added `AT_THRESHOLD_PROJECT` fixture (80/100=80%) + test: data-status=`'warning'` |
| H2 | HIGH | `AiSpendByProjectTable.test.tsx` | Missing BV test at exactly 100% exceeded threshold — `getBudgetStatus` `>= 100` boundary untested (Epic 2 Retro A2 violation) | **FIXED** — added `AT_EXCEEDED_PROJECT` fixture (100/100=100%) + test: data-status=`'exceeded'` |
| M1 | MEDIUM | `AiSpendByProjectTable.tsx:129` | `monthlyBudgetUsd` displayed without formatting — `$100` instead of `$100.00` | **FIXED** — `${p.monthlyBudgetUsd}` → `${p.monthlyBudgetUsd.toFixed(2)}` |
| M2 | MEDIUM | `AiSpendByModelChart.test.tsx:99-109` | Row test checks model/provider strings only — numeric values (`totalCostUsd`, `inputTokens`, `outputTokens`) untested | **FIXED** — added `$5.0000`, `100,000`, `20,000` assertions to row0 |
| M3 | MEDIUM | `AiSpendByProjectTable.test.tsx:161-172` | Budget % ascending sort test only checks `rows[0]` — `rows[1]` not verified (could pass if rows reversed) | **FIXED** — added `rows[1]?.textContent` assertion: `'Exceeded Project'` |
| M4 | MEDIUM | `AiSpendTrendChart.test.tsx` | Toggle button label text change not tested — `'Show L2/L3 Breakdown'` → `'Show Total'` logic has no assertion | **FIXED** — added test: default label `'Show L2/L3 Breakdown'`, after click → `'Show Total'` |
| L1 | LOW | All 4 test files | `beforeEach(() => vi.clearAllMocks())` is no-op — none of the 4 components have `vi.fn()` spies to clear | **FIXED** — removed `beforeEach` + `vi`/`beforeEach` from imports in all 4 files |
| L2 | LOW | `AiSpendByProjectTable.test.tsx:240-254` | Sort-reset test (Guardrail #12) only checks `aria-sort` attribute — row rendering order after reset not verified | **FIXED** — added row order assertions: `rows[0]` = Active Project, `rows[1]` = Zero Spend Project |
| L3 | LOW | `AiUsageSummaryCards.test.tsx:70` | Test name says `$0.3690` but component renders `$0.37` (2dp) — misleading description | **FIXED** — test name updated to `$0.37 (2 decimal places)` |
| L4 | LOW | `AiSpendByModelChart.tsx:46,49` | `'Cost (USD)'` string hardcoded in two places — Tooltip formatter and Bar name diverge if one changes | **FIXED** — extracted `const COST_LABEL = 'Cost (USD)' as const`; both usages reference constant |

**Final status:** 0C / 0H / 0M / 0L — all 10 fixed ✅

---

## Definition of Done

- [x] All ATDD P0 + P1 tests GREEN (43/43)
- [x] type-check clean
- [x] lint clean
- [x] Story file updated (tasks checked, file list complete)
- [x] Pre-CR scan: 0C + 0H — ready for CR
- [x] CR R1: 2H + 4M + 3L — all FIXED (48/48 GREEN, lint clean, type-check clean)
- [x] CR R2: 2H + 4M + 4L — all FIXED (55/55 GREEN, lint clean, type-check clean)
